═══════════════════════════════════════════════════════════════
    📅 개발 일지 - 2025년 12월 19일
═══════════════════════════════════════════════════════════════

🎯 프로젝트명: NoteGen (AI 필기 정리 앱)
👤 작업자: AI Assistant + starroad0328
⏰ 작업 시간: 약 2시간


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 1. 오늘 작업 요약
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ AI 정리 품질 개선 - 2단계 파이프라인 구현
✅ OCR 블록 압축 (토큰 절약)
✅ GPT-5 mini 토큰 한도 해결
✅ 모바일 폴링 에러 처리 개선
✅ GitHub 커밋 및 메인 브랜치 머지


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 2. 세부 작업 내용
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────────────────────────┐
│  2.1 AI 정리 2단계 파이프라인 구현                      │
└─────────────────────────────────────────────────────────┘

[ 배경 ]

  문제: GPT-5 mini의 토큰 한도 초과
    - max_completion_tokens = reasoning + output 합산
    - GPT-5 mini는 reasoning 토큰을 많이 사용
    - 출력 전에 토큰 한도 도달 → 빈 응답

[ 해결: 2단계 처리 ]

  1단계: 구조 파악 (가벼운 작업)
    - 목차 뽑기
    - 주제 분류
    - 누락 위험 구간 체크
    - max_completion_tokens: 3000

  2단계: 원본 유지 + 보강 정리 (핵심)
    - 원본 필기 내용 삭제/요약 금지
    - 빠진 설명만 [보강]으로 추가
    - max_completion_tokens: 6000

[ 구현 파일 ]

  backend/app/services/ai_service.py
    + _step1_analyze_structure() - 구조 파악
    + _step2_organize_with_structure() - 정리
    + _format_blocks_for_prompt() - 블록 포맷팅


┌─────────────────────────────────────────────────────────┐
│  2.2 OCR 블록 압축 구현                                 │
└─────────────────────────────────────────────────────────┘

[ 배경 ]

  문제: OCR 결과가 글자/단어 단위 → 토큰 낭비
  해결: 줄/블록 단위로 압축

[ 압축 로직 ]

  글자/단어 → 줄(Line)
    - y 중심값(cy) 기준으로 같은 줄 판정
    - cy 차이가 높이의 60% 이내면 같은 줄

  줄(Line) → 블록(Block)
    - 줄 간격이 평균 높이의 1.5배 이내
    - x 시작점 차이가 50px 이내
    - 좌표를 0~1000으로 정규화

[ 구현 파일 ]

  backend/app/services/ocr_service.py
    + _merge_words_to_lines() - 단어 → 줄
    + _merge_lines_to_blocks() - 줄 → 블록
    + _create_line_from_words() - 줄 생성
    + _create_block_from_lines() - 블록 생성

[ 효과 ]

  Before: 158개 단어 bbox → 대량 토큰 소비
  After: 10-20개 블록 → 토큰 대폭 절약


┌─────────────────────────────────────────────────────────┐
│  2.3 모바일 폴링 에러 처리 개선                         │
└─────────────────────────────────────────────────────────┘

[ 문제 ]

  - Network Error가 콘솔에 무한 스팸
  - 컴포넌트 언마운트 후에도 상태 업데이트 시도

[ 해결 ]

  1. setInterval → setTimeout 변경
     - 폴링 제어 더 정밀하게

  2. isMountedRef 추가
     - 언마운트 후 상태 업데이트 방지

  3. 지수 백오프 재시도
     - 최대 5회 재시도
     - 2초 → 3초 → 4.5초 → ...

  4. 에러 시 UI 피드백
     - 최대 재시도 초과 시 "다시 시도" 버튼

[ 구현 파일 ]

  mobile/app/processing/[id].tsx
    + isMountedRef, timeoutRef 추가
    + 재시도 로직 (MAX_RETRIES: 5)
    + handleRetry() 함수
    + 에러 상태 UI


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 3. 기술적 해결 과제
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────────────────────────┐
│  이슈 1: GPT-5 mini 토큰 한도 초과                      │
└─────────────────────────────────────────────────────────┘

  문제: finish_reason: "length", content: ""
  원인: reasoning 토큰이 대부분 소비
  해결:
    - 2단계 처리로 분할
    - 1단계: 3000 토큰
    - 2단계: 6000 토큰
    - 블록 압축으로 입력 토큰 절약


┌─────────────────────────────────────────────────────────┐
│  이슈 2: AIModel.GPT_5_NANO 미정의                      │
└─────────────────────────────────────────────────────────┘

  문제: user.py에 GPT_5_NANO enum 없음
  해결: GPT_5_MINI로 변경 (gpt-5-mini-2025-08-07)


┌─────────────────────────────────────────────────────────┐
│  이슈 3: Python __pycache__ 캐시                        │
└─────────────────────────────────────────────────────────┘

  문제: 코드 수정 후에도 이전 코드 실행
  해결: __pycache__ 폴더 삭제 + 서버 재시작


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 4. 파일 변경 내역
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[ 백엔드 ]

  backend/app/services/ai_service.py
    + 2단계 AI 처리 파이프라인
    + 블록 데이터 포맷팅
    + 단계별 토큰 한도 설정

  backend/app/services/ocr_service.py
    + 단어 → 줄 → 블록 압축
    + 좌표 정규화 (0-1000)
    + 메타데이터 구조 개선

  backend/app/models/user.py
    - GPT_5_NANO 참조 제거
    + GPT_5_MINI 기본값 사용

  backend/app/api/process.py
    + 디버그 로그 추가 (debug.log)

[ 모바일 ]

  mobile/app/processing/[id].tsx
    + 폴링 에러 처리 개선
    + 지수 백오프 재시도
    + 언마운트 정리 로직
    + 에러 상태 UI

  mobile/services/api.ts
    - 디버그 로그 정리


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 5. Git 커밋 이력
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

fa36f1f - feat: AI 정리 파이프라인 개선 (2단계 처리 + 블록 압축)
80fb48e - fix: 폴링 에러 처리 개선 - 재시도 로직 및 언마운트 정리


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 6. 테스트 결과
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[ AI 정리 테스트 ]

  입력: 필기 이미지 (OCR 블록 10-20개)

  1단계 결과:
    - finish_reason: stop
    - 구조 분석 정상 출력

  2단계 결과:
    - finish_reason: stop
    - 정리된 마크다운 출력
    - 처리 시간: 약 15-20초

[ 폴링 테스트 ]

  - Network Error 시 5회 재시도 후 에러 표시
  - 콘솔 스팸 없음
  - 언마운트 시 정상 정리


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 7. 성능 지표
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

토큰 사용량:
  - 1단계: 약 1000-2000 토큰
  - 2단계: 약 3000-5000 토큰
  - 총: 약 4000-7000 토큰/회

처리 시간:
  - OCR: 1-2초
  - AI 1단계: 5-8초
  - AI 2단계: 10-15초
  - 총: 약 15-25초


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 8. 작업 완료 체크리스트
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 2단계 AI 파이프라인 구현
✅ OCR 블록 압축 구현
✅ 토큰 한도 문제 해결
✅ 폴링 에러 처리 개선
✅ 메인 브랜치 머지 및 푸시
✅ 개발 일지 작성


═══════════════════════════════════════════════════════════════
                        작업 종료
═══════════════════════════════════════════════════════════════
