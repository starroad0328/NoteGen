═══════════════════════════════════════════════════════════════
    📅 개발 일지 - 2025년 12월 17일
═══════════════════════════════════════════════════════════════

🎯 프로젝트명: NoteGen (AI 필기 정리 앱)
👤 작업자: AI Assistant + starroad0328
⏰ 작업 시간: 약 3시간


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 1. 오늘 작업 요약
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ CLOVA OCR API 통합 완료
✅ OCR bbox + confidence 메타데이터 저장 구조 구현
✅ GPT-5 nano AI 정리 기능 활성화
✅ Expo SDK 54 업그레이드
✅ 전체 파이프라인 검증 (OCR → AI → 결과)
✅ GitHub 커밋 총 4개 (9380b4d ~ 6c25ebb)


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 2. 세부 작업 내용
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────────────────────────┐
│  2.1 CLOVA OCR API 통합                                 │
└─────────────────────────────────────────────────────────┘

[ 완료 사항 ]

  ✓ 네이버 클라우드 CLOVA OCR 회원가입
  ✓ API Gateway 상품 신청
  ✓ OCR 도메인 생성 (General, Premium)
  ✓ Secret Key 및 Invoke URL 발급
  ✓ backend/.env에 API 키 설정

  Secret Key: [REDACTED - .env 참조]
  Invoke URL: [REDACTED - .env 참조]

[ 구현 내용 ]

  파일: backend/app/services/ocr_service.py

  - CLOVA OCR API 호출 로직 구현
  - base64 이미지 인코딩
  - bbox, confidence 추출
  - tuple 반환: (text, metadata)

[ 테스트 결과 ]

  ✅ 한글 텍스트 인식 성공
  ✅ bbox 좌표 추출 성공 (158개 블록)
  ✅ confidence 1.0 ~ 0.99 범위
  ✅ 실제 필기 사진 테스트 완료


┌─────────────────────────────────────────────────────────┐
│  2.2 OCR 메타데이터 저장 구조 구현                      │
└─────────────────────────────────────────────────────────┘

[ 데이터베이스 스키마 변경 ]

  파일: backend/app/models/note.py

  추가 컬럼:
    - ocr_metadata: JSON 타입
    - bbox, confidence, source 저장

  저장 구조:
    {
      "images": [{
        "image_path": "./uploads/xxx.png",
        "blocks": [
          {
            "text": "안녕하세요",
            "bbox": [[29,32], [152,33], [151,64], [28,62]],
            "confidence": 1.0,
            "source": "clova"
          }
        ],
        "total_blocks": 158
      }]
    }

[ 구현 내용 ]

  - SQLAlchemy JSON 컬럼 추가
  - json.dumps()로 직렬화 저장
  - process.py에서 metadata 저장 로직 추가

[ 저장 용량 ]

  - 텍스트 블록 158개 기준: 약 24KB
  - 이미지 대비 무시 가능한 수준
  - 향후 Vision AI 및 오버레이 UX 기반


┌─────────────────────────────────────────────────────────┐
│  2.3 GPT-5 nano AI 정리 기능 통합                       │
└─────────────────────────────────────────────────────────┘

[ OpenAI API 설정 ]

  - API 키 발급 완료
  - backend/.env에 OPENAI_API_KEY 설정
  - 모델: gpt-5-nano (최신, 초저가)

[ GPT-5 nano 최적화 ]

  문제:
    - finish_reason: "length" + content: "" (빈 응답)
    - temperature 커스텀 불가
    - 생각 토큰(thinking tokens) 많이 소비

  해결:
    ✓ max_completion_tokens: 800 → 2000
    ✓ 프롬프트 극도 간소화
      Before: 250+ 토큰 (규칙 6개, 예시 포맷)
      After: 10토큰 ("제목과 글머리표로 정리:")
    ✓ 시스템 프롬프트 최소화
      Before: "당신은 학생들의..."
      After: "필기를 정리해주세요."
    ✓ temperature 제거 (기본값 사용)
    ✓ 빈 응답 에러 처리 추가

[ 테스트 결과 ]

  ✅ GPT-5 nano 정상 작동 확인
  ✅ OCR 텍스트 → AI 정리 파이프라인 검증
  ✅ 처리 시간: 약 10초

  입력: "안녕하세요 NoteGen OCR 테스트입니다 필기 인식 테스트 중"
  출력: "제목: NoteGen OCR 테스트 안내\n- 안녕하세요\n- NoteGen..."


┌─────────────────────────────────────────────────────────┐
│  2.4 Expo SDK 54 업그레이드                             │
└─────────────────────────────────────────────────────────┘

[ 업그레이드 내역 ]

  Expo SDK: 50 → 54
  React: 18.2.0 → 19.1.0
  React Native: 0.73.2 → 0.81.5

  추가 패키지:
    - expo-linking (필수 의존성)

[ 이슈 해결 ]

  - expo-router 의존성 충돌 → --legacy-peer-deps
  - 번들 캐시 재빌드
  - 1197개 모듈 정상 번들링

[ 연결 설정 ]

  - API URL: http://192.168.55.96:8000 (동적 IP)
  - React Native FormData 방식으로 이미지 업로드
  - axios multipart/form-data 전송


┌─────────────────────────────────────────────────────────┐
│  2.5 백엔드 설정 개선                                   │
└─────────────────────────────────────────────────────────┘

[ 패키지 추가 ]

  requirements.txt:
    - httpx (CLOVA OCR API 호출용)
    - pydantic-settings (환경변수 관리)

[ 설정 개선 ]

  config.py:
    - CLOVA_OCR_SECRET_KEY, INVOKE_URL 추가
    - ALLOWED_EXTENSIONS: set → str (파싱 오류 해결)
    - CORS_ORIGINS: list → str (property 변환)
    - extra = "ignore" (불필요한 env 무시)

  main.py:
    - emoji 제거 (Windows cp949 인코딩 오류 해결)
    - cors_origins_list property 사용

[ BackgroundTasks 개선 ]

  문제: DB 세션 직접 전달 시 세션 닫힘
  해결: 백그라운드 태스크 내부에서 새 세션 생성

  수정:
    - process_note_pipeline(note_id) # db 제거
    - SessionLocal() 내부 생성
    - finally: db.close()


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 3. 기술적 해결 과제
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────────────────────────┐
│  이슈 1: CLOVA OCR 연결 실패                            │
└─────────────────────────────────────────────────────────┘

  문제: clovaocr-api-kr.ncloud.com 연결 안 됨
  원인: 내부 IP (10.223.123.60) - 외부 접근 불가
  해결: API Gateway 신청 및 자동 연동
        → Gateway URL 사용


┌─────────────────────────────────────────────────────────┐
│  이슈 2: Expo SDK 의존성 충돌                           │
└─────────────────────────────────────────────────────────┘

  문제: expo-router 버전 충돌
  원인: React 19 peer dependency
  해결: npm install --legacy-peer-deps


┌─────────────────────────────────────────────────────────┐
│  이슈 3: GPT-5 nano 빈 응답                             │
└─────────────────────────────────────────────────────────┘

  문제: finish_reason: "length", content: ""
  원인: 생각 토큰 소진 후 출력 전 종료
  해결:
    - max_completion_tokens 2배 증가 (1200 → 2000)
    - 프롬프트 극도 간소화
    - temperature 제거


┌─────────────────────────────────────────────────────────┐
│  이슈 4: BackgroundTasks DB 세션 오류                   │
└─────────────────────────────────────────────────────────┘

  문제: 백그라운드 태스크에서 DB 세션 닫힘
  원인: FastAPI Depends(get_db) 세션 전달
  해결: 백그라운드 함수 내부에서 SessionLocal() 생성


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 4. 파일 변경 내역
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[ 백엔드 ]

  backend/app/services/ocr_service.py
    + CLOVA OCR API 호출 로직
    + bbox, confidence 추출
    + tuple 반환: (text, metadata)

  backend/app/models/note.py
    + ocr_metadata: JSON 컬럼 추가

  backend/app/api/process.py
    + ocr_metadata 저장 로직
    + AI 정리 기능 활성화
    + 디버깅 로그 추가 (debug.log)
    + BackgroundTasks 세션 처리 개선

  backend/app/services/ai_service.py
    + max_completion_tokens 사용
    + nano용 프롬프트 간소화
    + 빈 응답 에러 처리

  backend/app/core/config.py
    + CLOVA OCR 설정 추가
    + OPENAI_API_KEY 추가
    + extra = "ignore"

  backend/app/main.py
    + emoji 제거
    + cors_origins_list 사용

  backend/requirements.txt
    + httpx 추가

[ 모바일 ]

  mobile/app/upload.tsx
    + React Native FormData 방식
    + imageData 구조 수정

  mobile/services/api.ts
    + ImageFile 인터페이스 추가
    + API URL 동적 설정

  mobile/package.json
    + Expo SDK 54
    + expo-linking 추가

[ 문서 ]

  개발 규칙과 메모/파이프라인.txt (신규)
    - OCR → AI 전체 흐름
    - GPT-5 nano 주의사항
    - 성능 지표
    - 디버깅 가이드

  개발 규칙과 메모/개발 메모.txt
    - 작업 종료 메모 추가
    - 원본 프롬프트 백업


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 3. 기술적 해결 과제
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────────────────────────┐
│  이슈 1: CLOVA OCR 연결 실패                            │
└─────────────────────────────────────────────────────────┘

  문제: clovaocr-api-kr.ncloud.com 연결 안 됨
  원인: 내부 IP (10.223.123.60) - 외부 접근 불가
  해결: API Gateway 신청 및 자동 연동
        → Gateway URL 사용


┌─────────────────────────────────────────────────────────┐
│  이슈 2: Expo SDK 의존성 충돌                           │
└─────────────────────────────────────────────────────────┘

  문제: expo-router 버전 충돌
  원인: React 19 peer dependency
  해결: npm install --legacy-peer-deps


┌─────────────────────────────────────────────────────────┐
│  이슈 3: GPT-5 nano 빈 응답                             │
└─────────────────────────────────────────────────────────┘

  문제: finish_reason: "length", content: ""
  원인: 생각 토큰 소진 후 출력 전 종료
  해결:
    - max_completion_tokens 2배 증가 (800 → 2000)
    - 프롬프트 극도 간소화
    - temperature 제거


┌─────────────────────────────────────────────────────────┐
│  이슈 4: BackgroundTasks DB 세션 오류                   │
└─────────────────────────────────────────────────────────┘

  문제: 백그라운드 태스크에서 DB 세션 닫힘
  원인: FastAPI Depends(get_db) 세션 전달
  해결: 백그라운드 함수 내부에서 SessionLocal() 생성


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 4. Git 커밋 이력
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

9380b4d - feat: CLOVA OCR 통합 및 bbox 메타데이터 저장 기능 구현
4784825 - chore: .gitignore에 Expo 캐시 및 임시 파일 추가
eea6181 - docs: 개발 메모 업데이트 (2025-12-17)
7a144ea - feat: GPT-5 nano 통합 및 AI 정리 파이프라인 활성화
6c25ebb - docs: 작업 종료 메모 추가 (2025-12-17)


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 5. 테스트 결과
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[ CLOVA OCR 테스트 ]

  입력: 한글 필기 이미지
  출력:
    - 텍스트: 정상 추출
    - bbox: 158개 블록
    - confidence: 평균 0.95+
    - 메타데이터: 24KB (JSON)

[ GPT-5 nano 테스트 ]

  입력: "안녕하세요 NoteGen OCR 테스트입니다 필기 인식 테스트 중"
  출력: "제목: NoteGen OCR 테스트 안내\n- 안녕하세요\n- NoteGen..."

  처리 시간: 약 10초
  상태: COMPLETED
  토큰 사용: 약 150-400 tokens/회
  비용: 약 0.5원/회

[ 전체 파이프라인 ]

  1. 이미지 업로드 → ✅
  2. CLOVA OCR 추출 → ✅
  3. bbox 메타데이터 저장 → ✅
  4. GPT-5 nano 정리 → ✅
  5. 결과 반환 → ✅


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 6. 알려진 이슈 및 제약사항
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️ GPT-5 nano 제약
  - 프롬프트를 극도로 간소화해야 함
  - max_completion_tokens 최소 2000 필요
  - temperature 커스텀 불가 (기본값만)
  - 정리 품질이 제한적 (기본 수준)

⚠️ Windows 환경
  - emoji 사용 시 cp949 codec 에러
  - uvicorn 로그 한글 깨짐 (정상 동작)

⚠️ OCR 메타데이터
  - 이중 JSON 인코딩 이슈 (해결됨)
  - SQLAlchemy JSON vs TEXT 타입


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 7. 성능 지표
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

처리 시간:
  - CLOVA OCR: 1-2초
  - GPT-5 nano: 8-12초
  - 총: 약 10-15초

비용 (1회 처리):
  - CLOVA OCR: 약 10-15원 (프리미엄)
  - GPT-5 nano: 약 0.5원
  - 총: 약 15-20원/회

데이터 크기:
  - 이미지: 수백 KB ~ 수 MB
  - OCR 텍스트: 수백 bytes
  - bbox 메타데이터: 20-30 KB
  - 정리 결과: 1-2 KB


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 8. 다음 작업 계획
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔴 우선순위 1: AI 정리 품질 개선
  - GPT-5 nano 프롬프트 최적화 연구
  - 또는 gpt-4o-mini 대체 검토
  - 정리 결과 품질 향상 필요

🔴 우선순위 2: Vision AI 통합
  - GPT-4o Vision API 연동
  - 이미지 + OCR + bbox 통합 입력
  - 그림/도표/화살표 인식
  - 공간적 구조 파악

🟡 우선순위 3: 품질 테스트
  - 실제 필기 사진 10+ 장 테스트
  - OCR 정확도 측정
  - AI 정리 품질 평가
  - 사용자 시나리오 검증


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 9. 작업 완료 체크리스트
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ CLOVA OCR API 연동 완료
✅ OCR bbox 메타데이터 저장 완료
✅ GPT-5 nano AI 정리 완료
✅ 전체 파이프라인 테스트 완료
✅ 파이프라인 문서 작성 완료
✅ 개발 메모 업데이트 완료
✅ Git 커밋 및 푸시 완료 (5개 커밋)
✅ 서버 종료 완료
✅ 개발 일지 작성 완료


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 10. 참고 자료
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

CLOVA OCR:
  - https://www.ncloud.com/product/aiService/ocr
  - https://api.ncloud-docs.com/docs/ai-application-service-ocr

OpenAI GPT-5:
  - https://platform.openai.com/docs/models
  - https://platform.openai.com/api-keys

프로젝트 문서:
  - 개발 규칙과 메모/파이프라인.txt
  - docs/AI 비용과 유료 기능/AI_Model_Pricing.txt


═══════════════════════════════════════════════════════════════
                        작업 종료
═══════════════════════════════════════════════════════════════

다음 세션 시작 시:
  1. 개발 규칙과 메모/파이프라인.txt 확인
  2. 개발 규칙과 메모/개발 메모.txt 작업 종료 메모 확인
  3. AI 정리 품질 개선부터 시작

진행도: 90% → 98%
