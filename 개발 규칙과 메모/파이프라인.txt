═══════════════════════════════════════════════════════════════
                NoteGen 처리 파이프라인
═══════════════════════════════════════════════════════════════

최종 업데이트: 2025년 12월 17일


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 파이프라인 전체 흐름
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] 이미지 업로드
      ↓
[2] CLOVA OCR (텍스트 + bbox 추출)
      ↓
[3] GPT-5 AI 정리
      ↓
[4] 결과 반환


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Step 1: 이미지 업로드
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

엔드포인트: POST /api/upload/

입력:
  - files: 이미지 파일 (JPG, PNG)
  - organize_method: basic_summary | cornell

처리:
  1. 파일 저장 (uploads/ 디렉토리)
  2. DB에 Note 레코드 생성
  3. status = "uploading"

출력:
  {
    "id": 1,
    "title": "필기 2025-12-17 22:00",
    "status": "uploading"
  }


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Step 2: CLOVA OCR 처리
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

엔드포인트: POST /api/process/{note_id}/process

처리 과정:
  1. 이미지를 base64로 인코딩
  2. CLOVA OCR API 호출
  3. 응답에서 추출:
     - inferText: 인식된 텍스트
     - boundingPoly: 좌표 (bbox)
     - inferConfidence: 신뢰도

OCR 결과 구조:
  {
    "images": [{
      "image_path": "./uploads/xxx.png",
      "blocks": [
        {
          "text": "안녕하세요",
          "bbox": [[29, 32], [152, 33], [151, 64], [28, 62]],
          "confidence": 1.0,
          "source": "clova"
        },
        {
          "text": "NoteGen",
          "bbox": [[29, 87], [126, 88], [126, 109], [29, 108]],
          "confidence": 0.9991,
          "source": "clova"
        }
      ],
      "total_blocks": 158
    }]
  }

DB 저장:
  - note.ocr_text: "안녕하세요 NoteGen OCR..."
  - note.ocr_metadata: JSON(위 구조)


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Step 3: GPT-5 AI 정리
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

모델: gpt-5-nano (무료 플랜)

설정:
  - max_completion_tokens: 2000 (nano는 생각 토큰 많이 씀)
  - temperature: 기본값 (nano는 커스텀 불가)
  - system_prompt: 최소화 ("필기를 정리해주세요.")

프롬프트 전략:
  ✅ 극도로 간소화: "제목과 글머리표로 정리:"
  ✅ 정리 규칙 제거 (토큰 절약)
  ✅ 예시 포맷 제거
  ❌ 단계적 사고 요구 X
  ❌ JSON 출력 요구 X

입력:
  - system: "필기를 정리해주세요."
  - user: "제목과 글머리표로 정리:\n\n{ocr_text}"

출력:
  제목: NoteGen OCR 테스트
  - 안녕하세요
  - 테스트 중


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Step 4: 결과 저장 및 반환
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

DB 저장:
  - note.organized_content: AI 정리 결과
  - note.status: "completed"

API 응답:
  {
    "note_id": 1,
    "status": "completed",
    "message": "처리 완료!",
    "organized_content": "제목: ...\n- ..."
  }


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 GPT-5 nano 주의사항
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️ nano 특성:
  - 생각 토큰(thinking tokens)을 먼저 소비
  - 실제 출력 전에 토큰 소진 가능
  - finish_reason: "length" + content: "" 발생

해결책:
  ✅ max_completion_tokens 충분히 크게 (최소 2000)
  ✅ 프롬프트 극도로 간소화
  ✅ 시스템 프롬프트 최소화
  ❌ temperature 커스텀 불가 (기본값만)
  ❌ JSON strict 출력 불안정

빈 응답 처리:
  - finish_reason: "length" → 토큰 부족 에러
  - content: "" → 재시도 또는 에러


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 에러 처리 전략
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 빈 응답 (content: "")
   → "AI가 빈 응답을 반환했습니다" 에러
   → finish_reason 로그 기록

2. 토큰 초과 (finish_reason: "length")
   → "토큰 한도 초과: max_completion_tokens를 늘려야 합니다" 에러

3. API 키 오류
   → "Incorrect API key" 에러

4. CLOVA OCR 실패
   → "이미지에서 텍스트를 추출할 수 없습니다" 에러


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 디버깅 로그 위치
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

파일: backend/debug.log

로그 내용:
  [note_id] Starting OCR...
  [note_id] OCR result type: <class 'tuple'>
  [note_id] Text length: 36
  [note_id] Metadata JSON length: 995
  [note_id] Committed to DB
  [note_id] Starting AI processing...
  [note_id] AI result length: 150
  [note_id] AI processing completed


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 성능 지표
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

평균 처리 시간:
  - OCR: 1-2초
  - AI 정리: 8-12초
  - 총: 약 10-15초

토큰 사용량 (평균):
  - 입력: 50-100 tokens (간소화된 프롬프트)
  - 출력: 100-300 tokens
  - 총: 150-400 tokens/회

비용 (GPT-5 nano):
  - Input: $0.05/1M = 약 0.005원/1K
  - Output: $0.40/1M = 약 0.04원/1K
  - 1회 정리: 약 0.5원


═══════════════════════════════════════════════════════════════
